<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PDF Compressor | Free Online Tools</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Compress PDF to specific size (100KB, 200KB, 1MB) online free. Compare quality before downloading. Rename files, maintain quality, and optimize scanned documents securely.">
    <meta name="keywords" content="compress pdf to 200kb, pdf size reducer, reduce pdf size in kb, pdf optimizer, online pdf tool, compress scanned pdf, pdf quality compare">
    <meta name="author" content="Free Online Tools">

    <!-- Open Graph -->
    <meta property="og:title" content="Advanced PDF Compressor">
    <meta property="og:description" content="Compress PDF to exact size and preview quality instantly.">
    
    <!-- User's AdSense -->
    <meta name="google-adsense-account" content="ca-pub-3793390054330330">
    <script data-ad-client="ca-pub-3793390054330330" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .drag-active { border-color: #dc2626; background-color: #fef2f2; }
        
        .progress-bar { transition: width 0.3s ease; }

        /* Custom Tabs */
        .tab-btn.active { background-color: #fee2e2; color: #dc2626; border-color: #dc2626; }
        .tab-btn { border-bottom: 2px solid transparent; }
        
        /* Comparison Container */
        .compare-container canvas {
            width: 100%;
            height: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-red-600 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-file-zipper"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-gray-900">PDFCompress</span>
                </div>
                <div class="flex items-center gap-6 text-sm font-medium text-gray-500">
                    <a href="../../index.html" class="hover:text-red-600 transition">Home</a>
                    <a href="../../pages/contact.html" class="hover:text-red-600 transition">Contact</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 sm:px-6 w-full">
        
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-3">Advanced PDF Compressor</h1>
            <p class="text-gray-500 text-lg max-w-2xl mx-auto">
                Shrink PDF file size to specific KB (e.g., 200KB). Compare quality before downloading.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- Left Column: Controls -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Upload Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-5 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-semibold text-gray-800"><i class="fa-solid fa-upload mr-2 text-red-500"></i>Upload PDF</h3>
                    </div>
                    <div class="p-6">
                        <label id="dropZone" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition duration-200 group">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-400 group-hover:text-red-500 mb-2 transition"></i>
                                <p class="mb-1 text-sm text-gray-500"><span class="font-semibold text-gray-700">Click to upload</span></p>
                                <p class="text-xs text-gray-400">PDF files only (Max 20MB)</p>
                            </div>
                            <input type="file" id="fileInput" accept="application/pdf" class="hidden">
                        </label>
                        
                        <!-- File Info -->
                        <div id="fileInfo" class="hidden mt-4 bg-red-50 border border-red-100 p-3 rounded-lg flex items-center justify-between">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="bg-red-100 p-2 rounded text-red-600">
                                    <i class="fa-solid fa-file-pdf"></i>
                                </div>
                                <div class="truncate">
                                    <p id="fileName" class="text-sm font-medium text-gray-800 truncate">filename.pdf</p>
                                    <p id="fileSize" class="text-xs text-gray-500">0 KB</p>
                                </div>
                            </div>
                            <button id="clearBtn" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Settings Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    
                    <!-- Tabs -->
                    <div class="flex border-b border-gray-100">
                        <button id="tabAuto" class="flex-1 py-3 text-sm font-bold text-red-600 border-b-2 border-red-600 bg-red-50 tab-btn active" onclick="switchMode('auto')">
                            Target Size (KB)
                        </button>
                        <button id="tabManual" class="flex-1 py-3 text-sm font-bold text-gray-500 hover:text-gray-700 tab-btn" onclick="switchMode('manual')">
                            Manual Level
                        </button>
                    </div>

                    <div class="p-6 space-y-5">
                        
                        <!-- AUTO MODE: Target Size -->
                        <div id="modeAuto">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Target File Size (KB)</label>
                            <div class="relative">
                                <input type="number" id="targetSize" value="200" min="10" max="5000" class="block w-full border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm p-2.5 pr-12 border">
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                    <span class="text-gray-500 sm:text-sm">KB</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 italic">
                                *We try our best to reach this size, but exact size depends on file content.
                            </p>
                            <div class="flex gap-2 mt-2">
                                <button onclick="setTarget(100)" class="text-xs bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 px-3 py-1 rounded border">100KB</button>
                                <button onclick="setTarget(200)" class="text-xs bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 px-3 py-1 rounded border">200KB</button>
                                <button onclick="setTarget(500)" class="text-xs bg-gray-100 hover:bg-red-50 text-gray-600 hover:text-red-600 px-3 py-1 rounded border">500KB</button>
                            </div>
                        </div>

                        <!-- MANUAL MODE -->
                        <div id="modeManual" class="hidden space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <label class="text-sm font-medium text-gray-700">Quality</label>
                                    <span id="qualityVal" class="text-xs font-bold bg-gray-100 px-2 py-1 rounded">50%</span>
                                </div>
                                <input type="range" id="qualityRange" min="0.1" max="1.0" step="0.1" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-600">
                            </div>

                            <div>
                                <label class="text-sm font-medium text-gray-700 mb-2 block">Resolution (DPI)</label>
                                <select id="dpiSelect" class="block w-full border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm p-2.5 border">
                                    <option value="0.5">Low (Screen)</option>
                                    <option value="1.0" selected>Medium (Standard)</option>
                                    <option value="2.0">High (Print)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Common: Grayscale -->
                        <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                            <label class="text-sm font-medium text-gray-700">Grayscale (B&W)</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="grayscaleToggle" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-400 -mt-3">Converts to black & white for maximum compression.</p>

                        <button id="compressBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-4 rounded-lg shadow transition duration-150 ease-in-out flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fa-solid fa-compress"></i> Compress PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Status & Download -->
            <div class="lg:col-span-7 space-y-6">
                
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden min-h-[400px] flex flex-col justify-center items-center p-8 text-center">
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="text-gray-400">
                        <i class="fa-regular fa-file-pdf text-6xl mb-4 opacity-30"></i>
                        <p>Upload a PDF to start compressing</p>
                    </div>

                    <!-- Progress State -->
                    <div id="progressState" class="hidden w-full max-w-sm">
                        <div class="mb-4">
                            <i class="fa-solid fa-gear fa-spin text-4xl text-red-500 mb-4"></i>
                            <h3 class="text-lg font-bold text-gray-900" id="statusTitle">Compressing...</h3>
                            <p id="pageStatus" class="text-sm text-gray-500 mt-1">Analyzing pages...</p>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2 overflow-hidden">
                            <div id="progressBar" class="bg-red-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-400">Processing locally in browser...</p>
                    </div>

                    <!-- Success State -->
                    <div id="successState" class="hidden w-full fade-in text-left">
                        
                        <div class="flex items-center justify-center gap-2 mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">Compression Complete!</h2>
                            <div id="savingBadge" class="inline-block bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full">
                                Saved <span id="savedPercent">0%</span>
                            </div>
                        </div>
                        
                        <p id="targetMsg" class="text-center text-sm text-gray-500 mb-4 hidden"></p>

                        <!-- Visual Comparison -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 compare-container">
                            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <div class="flex justify-between mb-2">
                                    <span class="text-xs font-bold text-gray-500 uppercase">Original (First Page)</span>
                                    <span id="sizeBefore" class="text-xs font-mono text-gray-600 font-bold">0 MB</span>
                                </div>
                                <canvas id="previewOriginal"></canvas>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg border border-green-200">
                                <div class="flex justify-between mb-2">
                                    <span class="text-xs font-bold text-green-600 uppercase">Compressed (First Page)</span>
                                    <span id="sizeAfter" class="text-xs font-mono text-green-600 font-bold">0 MB</span>
                                </div>
                                <canvas id="previewCompressed"></canvas>
                            </div>
                        </div>

                        <!-- Rename Input -->
                        <div class="mb-4 max-w-md mx-auto">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Save As</label>
                            <div class="flex">
                                <input type="text" id="filenameInput" class="block w-full border-gray-300 rounded-l-lg shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm p-2.5 border" placeholder="compressed_file">
                                <span class="inline-flex items-center px-3 rounded-r-lg border border-l-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">.pdf</span>
                            </div>
                        </div>

                        <div class="text-center space-y-3">
                            <button id="downloadBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform hover:scale-[1.02] text-center">
                                <i class="fa-solid fa-download mr-2"></i> Download PDF
                            </button>
                            <div class="block">
                                <button onclick="location.reload()" class="text-sm text-gray-500 hover:text-gray-700 underline">Compress Another File</button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Info Box -->
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-1 flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> Smart Compression
                    </h4>
                    <p class="text-sm text-blue-700">
                        This tool rasterizes PDF pages into images to reduce size. This is perfect for <strong>scanned documents</strong>. Note: Text may become non-selectable.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500">
                &copy; 2023 Free Online Tools. <a href="../../pages/privacy.html" class="text-red-600 hover:text-red-500">Privacy Policy</a>
            </p>
        </div>
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        (function() {
            // UI Elements
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');
            const fileInfo = document.getElementById('fileInfo');
            const fileNameEl = document.getElementById('fileName');
            const fileSizeEl = document.getElementById('fileSize');
            const clearBtn = document.getElementById('clearBtn');
            const compressBtn = document.getElementById('compressBtn');
            
            const modeAuto = document.getElementById('modeAuto');
            const modeManual = document.getElementById('modeManual');
            const tabAuto = document.getElementById('tabAuto');
            const tabManual = document.getElementById('tabManual');
            
            const targetSizeInput = document.getElementById('targetSize');
            const qualityRange = document.getElementById('qualityRange');
            const qualityVal = document.getElementById('qualityVal');
            const dpiSelect = document.getElementById('dpiSelect');
            const grayscaleToggle = document.getElementById('grayscaleToggle');
            
            const emptyState = document.getElementById('emptyState');
            const progressState = document.getElementById('progressState');
            const successState = document.getElementById('successState');
            const progressBar = document.getElementById('progressBar');
            const pageStatus = document.getElementById('pageStatus');
            const statusTitle = document.getElementById('statusTitle');
            
            const sizeBefore = document.getElementById('sizeBefore');
            const sizeAfter = document.getElementById('sizeAfter');
            const savedPercent = document.getElementById('savedPercent');
            const downloadBtn = document.getElementById('downloadBtn');
            const filenameInput = document.getElementById('filenameInput');
            const targetMsg = document.getElementById('targetMsg');

            let currentFile = null;
            let currentMode = 'auto'; 
            let processedPdfBlob = null;

            // --- Switch Mode ---
            window.switchMode = (mode) => {
                currentMode = mode;
                if(mode === 'auto') {
                    modeAuto.classList.remove('hidden');
                    modeManual.classList.add('hidden');
                    tabAuto.classList.add('active', 'text-red-600', 'border-red-600', 'bg-red-50');
                    tabAuto.classList.remove('text-gray-500');
                    tabManual.classList.remove('active', 'text-red-600', 'border-red-600', 'bg-red-50');
                    tabManual.classList.add('text-gray-500');
                } else {
                    modeAuto.classList.add('hidden');
                    modeManual.classList.remove('hidden');
                    tabManual.classList.add('active', 'text-red-600', 'border-red-600', 'bg-red-50');
                    tabManual.classList.remove('text-gray-500');
                    tabAuto.classList.remove('active', 'text-red-600', 'border-red-600', 'bg-red-50');
                    tabAuto.classList.add('text-gray-500');
                }
            }

            window.setTarget = (val) => {
                targetSizeInput.value = val;
            }

            // --- Drag & Drop ---
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }));
            dropZone.addEventListener('dragenter', () => dropZone.classList.add('drag-active'));
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('drag-active');
                handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

            function handleFile(file) {
                if (!file || file.type !== 'application/pdf') {
                    alert("Please upload a PDF file.");
                    return;
                }
                
                // 20MB Check
                if (file.size > 20 * 1024 * 1024) {
                     alert("File is too large! Please upload a PDF smaller than 20MB.");
                     return;
                }

                currentFile = file;
                
                // Filename Regex Fix
                const fName = file.name.replace(/\.pdf$/i, '');
                fileNameEl.textContent = file.name;
                fileSizeEl.textContent = formatBytes(file.size);
                filenameInput.value = fName + '_compressed'; 
                
                dropZone.classList.add('hidden');
                fileInfo.classList.remove('hidden');
                compressBtn.disabled = false;
                
                successState.classList.add('hidden');
                progressState.classList.add('hidden');
                emptyState.classList.remove('hidden');
            }

            clearBtn.addEventListener('click', () => {
                currentFile = null;
                fileInput.value = '';
                fileInfo.classList.add('hidden');
                dropZone.classList.remove('hidden');
                compressBtn.disabled = true;
                successState.classList.add('hidden');
                progressState.classList.add('hidden');
                emptyState.classList.remove('hidden');
            });

            qualityRange.addEventListener('input', () => {
                const val = parseFloat(qualityRange.value);
                qualityVal.textContent = `${Math.round(val*100)}%`;
            });

            // --- Compression Logic ---
            compressBtn.addEventListener('click', async () => {
                if(!currentFile) return;

                emptyState.classList.add('hidden');
                successState.classList.add('hidden');
                progressState.classList.remove('hidden');
                compressBtn.disabled = true;
                
                const isGrayscale = grayscaleToggle.checked;
                let quality = 0.5;
                let scale = 1.0;

                if (currentMode === 'manual') {
                    quality = parseFloat(qualityRange.value);
                    scale = parseFloat(dpiSelect.value);
                    const blob = await generatePDFBlob(quality, scale, isGrayscale);
                    await showSuccess(blob);
                } else {
                    await runSmartCompression(isGrayscale);
                }
            });

            async function runSmartCompression(isGrayscale) {
                const targetBytes = parseInt(targetSizeInput.value) * 1024;
                const originalBytes = currentFile.size;
                
                // Calculate Ratio
                const ratio = targetBytes / originalBytes;
                
                // Heuristics based on ratio
                let attempts = [];
                
                if (ratio >= 1) {
                   // Target larger than original - just do high quality
                   attempts = [{ q: 0.9, s: 1.0 }];
                } else if (ratio > 0.5) {
                   // Needs mild compression
                   attempts = [{ q: 0.7, s: 1.0 }, { q: 0.5, s: 0.8 }];
                } else if (ratio > 0.2) {
                   // Needs strong compression
                   attempts = [{ q: 0.4, s: 0.7 }, { q: 0.3, s: 0.5 }];
                } else {
                   // Needs extreme compression
                   attempts = [{ q: 0.2, s: 0.5 }, { q: 0.1, s: 0.4 }];
                }

                statusTitle.textContent = "Smart Compressing...";

                for (let i = 0; i < attempts.length; i++) {
                    const settings = attempts[i];
                    pageStatus.textContent = `Optimization Pass ${i+1}...`;
                    
                    const blob = await generatePDFBlob(settings.q, settings.s, isGrayscale);
                    
                    if (blob.size <= targetBytes || i === attempts.length - 1) {
                        if(blob.size > targetBytes) {
                             targetMsg.textContent = `Note: Could not reach exact target. Closest result shown.`;
                             targetMsg.classList.remove('hidden');
                        } else {
                             targetMsg.classList.add('hidden');
                        }
                        await showSuccess(blob);
                        return;
                    }
                }
            }

            async function generatePDFBlob(quality, scale, isGrayscale) {
                // Canvas Reuse Strategy
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { willReadFrequently: true });
                
                const arrayBuffer = await currentFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const totalPages = pdf.numPages;
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF(); 
                const pageWidth = 210; 
                const pageHeight = 297;

                for (let i = 1; i <= totalPages; i++) {
                    const percent = Math.round(((i-1) / totalPages) * 100);
                    progressBar.style.width = `${percent}%`;
                    pageStatus.textContent = `Processing Page ${i} of ${totalPages}...`;
                    
                    // Unblock UI
                    await new Promise(r => setTimeout(r, 0));

                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: scale }); 
                    
                    // Resize existing canvas
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    
                    if(isGrayscale) {
                        const imgData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imgData.data;
                        for (let j = 0; j < data.length; j += 4) {
                            const avg = (data[j] + data[j + 1] + data[j + 2]) / 3;
                            data[j] = avg; data[j + 1] = avg; data[j + 2] = avg;
                        }
                        context.putImageData(imgData, 0, 0);
                    }

                    const imgData = canvas.toDataURL('image/jpeg', quality);

                    if (i > 1) doc.addPage();
                    doc.addImage(imgData, 'JPEG', 0, 0, pageWidth, pageHeight);
                }

                progressBar.style.width = '100%';
                return doc.output('blob');
            }

            async function renderPreview(data, canvasId) {
                try {
                    const pdf = await pdfjsLib.getDocument({data: data}).promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 0.5 }); // Thumbnail scale
                    const canvas = document.getElementById(canvasId);
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                } catch(e) {
                    console.error("Preview Render Error", e);
                }
            }

            async function showSuccess(blob) {
                processedPdfBlob = blob;
                progressState.classList.add('hidden');
                successState.classList.remove('hidden');
                
                sizeBefore.textContent = formatBytes(currentFile.size);
                sizeAfter.textContent = formatBytes(blob.size);
                
                const saved = ((currentFile.size - blob.size) / currentFile.size * 100).toFixed(1);
                
                const savedPercentEl = document.getElementById('savedPercent');
                const savingBadgeEl = document.getElementById('savingBadge');

                if (savedPercentEl && savingBadgeEl) {
                    if(saved > 0) {
                        savedPercentEl.textContent = `${saved}%`;
                        savingBadgeEl.className = "inline-block bg-green-100 text-green-800 text-xs font-bold px-3 py-1 rounded-full";
                    } else {
                        savedPercentEl.textContent = "0%";
                        savingBadgeEl.className = "inline-block bg-yellow-100 text-yellow-800 text-xs font-bold px-3 py-1 rounded-full";
                    }
                }
                
                // Render Previews
                try {
                    const originalBuffer = await currentFile.arrayBuffer();
                    await renderPreview(originalBuffer, 'previewOriginal');
                    
                    const compressedBuffer = await blob.arrayBuffer();
                    await renderPreview(compressedBuffer, 'previewCompressed');
                } catch (e) {
                    console.error("Preview generation failed:", e);
                }
                
                compressBtn.disabled = false;
            }
            
            downloadBtn.addEventListener('click', () => {
                if(!processedPdfBlob) return;
                
                let name = filenameInput.value.trim() || 'compressed';
                if(!name.toLowerCase().endsWith('.pdf')) name += '.pdf';
                
                const url = URL.createObjectURL(processedPdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });

            function formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

        })();
    </script>
</body>
</html>