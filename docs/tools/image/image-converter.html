<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Image Converter & Resizer | Free Online Tools</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Free online Batch Image Converter. Convert, Resize, and Watermark images instantly. Supports WebP, AVIF, JPG, PNG. Offline capable PWA.">
    <meta name="keywords" content="bulk image converter, image resizer, add watermark online, jpg to webp, png to avif, batch photo editor">
    <meta name="author" content="Free Online Tools">
    
    <!-- PWA Manifest Placeholder -->
    <link rel="manifest" href="data:application/json;base64,eyJkYXRhIjogInBsYWNlaG9sZGVyIn0=">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- JSZip for Bulk Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        /* Drag Zone Active State */
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Accordion Transition */
        .accordion-content { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; }
        .accordion-content.open { max-height: 500px; }
        
        /* Toast Notification */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: #10b981; color: white;
            padding: 12px 24px; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 100; transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show { transform: translateY(0); }
        .toast.error { background: #ef4444; }
        .toast.info { background: #3b82f6; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">ImgConvert <span class="text-indigo-600 text-xs align-top">PRO</span></span>
                </div>
                <div class="flex items-center gap-6 text-sm font-medium text-slate-500">
                    <a href="../../index.html" class="hover:text-indigo-600 transition">Home</a>
                    <a href="../../pages/contact.html" class="hover:text-indigo-600 transition">Contact</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-10 sm:px-6 w-full">
        
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 mb-3">
                Batch Image Processor
            </h1>
            <p class="text-slate-500 text-lg max-w-2xl mx-auto">
                Convert, Resize, and Watermark multiple images. <span class="text-indigo-600 font-bold">Offline Capable & Fast.</span>
            </p>
            <!-- Preset Buttons -->
            <div class="flex justify-center gap-4 mt-6">
                <button onclick="savePreset()" class="text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded transition border border-indigo-200">
                    <i class="fa-solid fa-save mr-1"></i> Save Preset
                </button>
                <button onclick="loadPreset()" class="text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded transition border border-indigo-200">
                    <i class="fa-solid fa-upload mr-1"></i> Load Preset
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- Left: Settings & Upload -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- 1. Conversion Settings -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-format')" aria-expanded="true">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-file-export text-indigo-500"></i> Format & Quality</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-format" class="accordion-content open p-6 border-t border-gray-100">
                        <div class="space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Output Format</label>
                                <div class="grid grid-cols-2 gap-2" role="group" aria-label="Output Format Selection">
                                    <button onclick="setFormat('image/webp', this)" class="format-btn active bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold border border-indigo-600 transition">WebP</button>
                                    <button onclick="setFormat('image/jpeg', this)" class="format-btn bg-white text-slate-600 py-2 rounded-lg text-sm font-bold border border-gray-200 hover:border-gray-300 transition">JPG</button>
                                    <button onclick="setFormat('image/png', this)" class="format-btn bg-white text-slate-600 py-2 rounded-lg text-sm font-bold border border-gray-200 hover:border-gray-300 transition">PNG</button>
                                    <button onclick="setFormat('image/avif', this)" class="format-btn bg-white text-slate-600 py-2 rounded-lg text-sm font-bold border border-gray-200 hover:border-gray-300 transition relative">
                                        AVIF <span class="absolute -top-1 -right-1 flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                                    </button>
                                </div>
                            </div>
                            <div id="qualityControl">
                                <div class="flex justify-between mb-2">
                                    <label class="text-xs font-bold text-slate-500 uppercase">Quality</label>
                                    <span class="text-xs font-bold text-indigo-600" id="qualityVal">80%</span>
                                </div>
                                <input type="range" id="quality" min="10" max="100" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" aria-label="Image Quality">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Resize Settings -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-resize')" aria-expanded="false">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-ruler-combined text-blue-500"></i> Resize (Optional)</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-resize" class="accordion-content p-6 border-t border-gray-100">
                        <div class="space-y-4">
                            <!-- Presets -->
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button onclick="setPresetResize(1280, 720)" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded">HD (720p)</button>
                                <button onclick="setPresetResize(1920, 1080)" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded">FHD (1080p)</button>
                                <button onclick="setPresetScale(0.5)" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded">50% Scale</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Width (px)</label>
                                    <input type="number" id="resizeWidth" placeholder="Auto" class="w-full border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Height (px)</label>
                                    <input type="number" id="resizeHeight" placeholder="Auto" class="w-full border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Watermark Settings -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-watermark')" aria-expanded="false">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-stamp text-purple-500"></i> Watermark</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-watermark" class="accordion-content p-6 border-t border-gray-100">
                         <div class="space-y-4">
                             <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Text</label>
                                <input type="text" id="watermarkText" placeholder="e.g. Â© MyWebsite" class="w-full border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Position</label>
                                    <select id="watermarkPos" class="w-full border-gray-300 rounded-lg text-sm p-2">
                                        <option value="bottom-right">Bottom Right</option>
                                        <option value="bottom-left">Bottom Left</option>
                                        <option value="top-right">Top Right</option>
                                        <option value="top-left">Top Left</option>
                                        <option value="center">Center</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Opacity</label>
                                    <input type="number" id="watermarkOpacity" value="0.5" step="0.1" min="0.1" max="1" class="w-full border-gray-300 rounded-lg text-sm p-2">
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
                
                <!-- 4. Renaming -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                     <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-rename')" aria-expanded="false">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-i-cursor text-teal-500"></i> Rename Files</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-rename" class="accordion-content p-6 border-t border-gray-100">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Filename Prefix</label>
                        <div class="flex items-center gap-2">
                             <input type="text" id="renamePrefix" placeholder="image" class="flex-grow border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                             <span class="text-gray-400 text-sm">-01.ext</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Area -->
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 bg-slate-50 hover:bg-white hover:border-indigo-400 transition cursor-pointer text-center group relative focus-within:ring-2 focus-within:ring-indigo-500" role="button" aria-label="Upload images by clicking or dropping files" tabindex="0">
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                    <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                    </div>
                    <h3 class="text-slate-700 font-bold mb-1">Click, Paste or Drop Images</h3>
                    <p class="text-slate-400 text-xs">Supports JPG, PNG, WEBP, BMP (Max 50MB)</p>
                </div>
                
                <div class="flex gap-2">
                    <!-- Generate Report -->
                    <button onclick="generateReport()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl shadow transition text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-file-csv"></i> Report
                    </button>
                    <!-- Download All -->
                    <button id="downloadAllBtn" onclick="downloadAll()" class="flex-[2] hidden bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                        <i class="fa-solid fa-file-zipper"></i> Download All as ZIP
                    </button>
                </div>

            </div>

            <!-- Right: Results -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden min-h-[600px] flex flex-col">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Conversion Queue</h3>
                        <div class="flex items-center gap-3">
                             <!-- Global Progress -->
                             <div id="globalProgress" class="hidden flex items-center gap-2 mr-2" role="progressbar" aria-label="Conversion progress" aria-valuemin="0" aria-valuemax="100">
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="globalProgressBar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="globalProgressText" class="text-xs text-slate-500 font-mono">0/0</span>
                             </div>

                             <button onclick="clearAll()" class="text-xs text-red-500 hover:text-red-700 font-medium hidden" id="clearAllBtn">Clear All</button>
                             <span class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md" id="fileCount">0 Files</span>
                        </div>
                    </div>
                    
                    <!-- Restore Banner (Hidden) -->
                    <div id="restoreBanner" class="hidden bg-blue-50 p-3 border-b border-blue-100 flex justify-between items-center px-6">
                        <span class="text-xs text-blue-700 font-bold"><i class="fa-solid fa-clock-rotate-left mr-2"></i> Unsaved files found from last session.</span>
                        <div class="flex gap-2">
                            <button onclick="restoreSession()" class="text-xs bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">Restore</button>
                            <button onclick="clearDB()" class="text-xs text-blue-500 hover:text-blue-700 px-2">Discard</button>
                        </div>
                    </div>

                    <div id="resultsList" class="flex-grow p-6 space-y-4 overflow-y-auto max-h-[800px]">
                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-32 text-gray-400">
                            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-regular fa-images text-4xl opacity-50"></i>
                            </div>
                            <p>Upload or Paste (Ctrl+V) images to start processing.</p>
                        </div>
                        
                        <!-- List Items -->
                    </div>
                </div>
            </div>

        </div>

    </main>
    
    <!-- Comparison Modal (Dynamic) -->

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-slate-500">
                &copy; 2023 Free Online Tools. <a href="../../pages/privacy.html" class="text-indigo-600 hover:text-indigo-500">Privacy Policy</a>
            </p>
        </div>
    </footer>

    <script>
        (function() {
            // Worker Script
            const workerCode = `
                self.onmessage = async function(e) {
                    const { bitmap, format, quality, targetW, targetH, wmText, wmPos, wmOpacity, id, originalSize } = e.data;
                    
                    try {
                        let width = bitmap.width;
                        let height = bitmap.height;
                        
                        // Resize Logic
                        if (targetW && targetH) { width = targetW; height = targetH; }
                        else if (targetW) { const ratio = targetW / width; width = targetW; height = height * ratio; }
                        else if (targetH) { const ratio = targetH / height; height = targetH; width = width * ratio; }
                        
                        // Smart Suggestion Logic using Sample Data
                        let suggestion = "";
                        
                        // Create 100x100 canvas for fast pixel analysis
                        const sampleCanvas = new OffscreenCanvas(100, 100);
                        const sampleCtx = sampleCanvas.getContext('2d');
                        sampleCtx.drawImage(bitmap, 0, 0, 100, 100);
                        const imgData = sampleCtx.getImageData(0, 0, 100, 100);
                        const pixels = imgData.data;
                        
                        let hasAlpha = false;
                        // Check alpha channel
                        for(let i = 3; i < pixels.length; i += 4) {
                            if(pixels[i] < 255) { hasAlpha = true; break; }
                        }
                        
                        if(hasAlpha && format === 'image/jpeg') {
                            suggestion = "âš ï¸ Transparency detected. Background will be black. Use PNG/WebP.";
                        } else if(!hasAlpha && format === 'image/png' && originalSize > 500*1024) {
                            suggestion = "ðŸ’¡ No transparency. Try WebP/JPEG for smaller size.";
                        }

                        // Main Processing Canvas
                        const canvas = new OffscreenCanvas(width, height);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(bitmap, 0, 0, width, height);

                        if (wmText) {
                            const fontSize = Math.max(12, width * 0.05);
                            ctx.font = \`bold \${fontSize}px sans-serif\`;
                            ctx.globalAlpha = wmOpacity;
                            ctx.fillStyle = "white";
                            ctx.shadowColor="rgba(0,0,0,0.5)"; 
                            ctx.shadowBlur=4;
                            
                            const metrics = ctx.measureText(wmText);
                            const txtW = metrics.width;
                            const txtH = fontSize;
                            const pad = 20;
                            
                            let x, y;
                            if(wmPos === 'bottom-right') { x = width - txtW - pad; y = height - pad; }
                            else if(wmPos === 'bottom-left') { x = pad; y = height - pad; }
                            else if(wmPos === 'top-right') { x = width - txtW - pad; y = txtH + pad; }
                            else if(wmPos === 'top-left') { x = pad; y = txtH + pad; }
                            else { x = (width - txtW)/2; y = (height + txtH)/2; }
                            
                            ctx.fillText(wmText, x, y);
                        }

                        const blob = await canvas.convertToBlob({ type: format, quality: quality });
                        self.postMessage({ id, blob, success: true, suggestion });

                    } catch (err) {
                        self.postMessage({ id, error: err.message, success: false });
                    }
                };
            `;
            
            const workerBlob = new Blob([workerCode], { type: "application/javascript" });
            const workerUrl = URL.createObjectURL(workerBlob);
            
            // State
            let targetFormat = 'image/webp';
            let quality = 0.8;
            let filesQueue = [];
            let convertedFiles = []; 
            let activeWorkers = 0;
            let queueIndex = 0;
            let completedCount = 0;
            const MAX_WORKERS = navigator.hardwareConcurrency || 4;
            
            // IndexedDB
            let db;

            // Elements
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');
            const qualityInput = document.getElementById('quality');
            const qualityVal = document.getElementById('qualityVal');
            const resultsList = document.getElementById('resultsList');
            const emptyState = document.getElementById('emptyState');
            const fileCount = document.getElementById('fileCount');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const formatBtns = document.querySelectorAll('.format-btn');
            const qualityControl = document.getElementById('qualityControl');
            
            const globalProgress = document.getElementById('globalProgress');
            const globalProgressBar = document.getElementById('globalProgressBar');
            const globalProgressText = document.getElementById('globalProgressText');
            const restoreBanner = document.getElementById('restoreBanner');
            
            const resizeWidth = document.getElementById('resizeWidth');
            const resizeHeight = document.getElementById('resizeHeight');
            const watermarkText = document.getElementById('watermarkText');
            const watermarkPos = document.getElementById('watermarkPos');
            const watermarkOpacity = document.getElementById('watermarkOpacity');
            const renamePrefix = document.getElementById('renamePrefix');

            // --- Database ---
            async function initDB() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open('ImgConverterDB', 1);
                    req.onupgradeneeded = e => {
                        db = e.target.result;
                        if(!db.objectStoreNames.contains('pending')) {
                            db.createObjectStore('pending', { keyPath: 'id' });
                        }
                    };
                    req.onsuccess = e => { db = e.target.result; resolve(db); };
                    req.onerror = e => reject(e);
                });
            }

            async function saveToDB(id, blob, filename) {
                if(!db) return;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(['pending'], 'readwrite');
                    tx.objectStore('pending').put({ id, blob, filename, timestamp: Date.now() });
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }

            window.clearDB = async function() {
                if(!db) return;
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(['pending'], 'readwrite');
                    tx.objectStore('pending').clear();
                    tx.oncomplete = () => {
                        restoreBanner.classList.add('hidden');
                        resolve();
                    };
                    tx.onerror = () => reject(tx.error);
                });
            }

            window.restoreSession = async function() {
                if(!db) return;
                const tx = db.transaction(['pending'], 'readonly');
                const all = await new Promise(resolve => {
                    const req = tx.objectStore('pending').getAll();
                    req.onsuccess = () => resolve(req.result);
                });
                
                if(all.length > 0) {
                    emptyState.classList.add('hidden');
                    clearAllBtn.classList.remove('hidden');
                    
                    all.forEach(item => {
                         const mockFile = { name: item.filename, size: item.blob.size };
                         createListItem(item.id, mockFile); 
                         handleSuccess(item.id, mockFile, item.blob, 0, "Restored");
                    });
                    restoreBanner.classList.add('hidden');
                }
            }

            window.addEventListener('load', async () => {
                try {
                    await initDB();
                    const tx = db.transaction(['pending'], 'readonly');
                    const req = tx.objectStore('pending').count();
                    req.onsuccess = () => {
                        if(req.result > 0) restoreBanner.classList.remove('hidden');
                    };
                } catch(e) { console.log("DB Error", e); }
            });

            // --- UI Helper Functions ---
            window.toggleAccordion = (id) => {
                const el = document.getElementById(id);
                el.classList.toggle('open');
                const btn = el.previousElementSibling;
                btn.setAttribute('aria-expanded', el.classList.contains('open'));
            };
            
            window.setFormat = (fmt, btn) => {
                targetFormat = fmt;
                formatBtns.forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                    b.classList.add('bg-white', 'text-slate-600', 'border-gray-200');
                });
                btn.classList.remove('bg-white', 'text-slate-600', 'border-gray-200');
                btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                
                if(fmt === 'image/png') qualityControl.classList.add('opacity-50', 'pointer-events-none');
                else qualityControl.classList.remove('opacity-50', 'pointer-events-none');
            };

            window.setPresetResize = (w, h) => {
                resizeWidth.value = w;
                resizeHeight.value = h;
            };
            
            window.setPresetScale = (scale) => {
                resizeWidth.value = '';
                resizeHeight.value = '';
                alert("Scale preset requires specific image context. Please enter pixel values for bulk resize.");
            };

            window.savePreset = () => {
                const preset = {
                    format: targetFormat,
                    quality: quality,
                    watermark: watermarkText.value
                };
                localStorage.setItem('imgConvertPreset', JSON.stringify(preset));
                window.showToast('Preset saved!', 'success');
            };
            
            window.loadPreset = () => {
                const preset = JSON.parse(localStorage.getItem('imgConvertPreset'));
                if(preset) {
                    if(preset.format) {
                        const btn = Array.from(formatBtns).find(b => b.innerText.includes(preset.format.split('/')[1].toUpperCase()));
                        if(btn) setFormat(preset.format, btn);
                    }
                    if(preset.quality) {
                        quality = preset.quality;
                        qualityInput.value = quality * 100;
                        qualityVal.innerText = (quality*100) + '%';
                    }
                    if(preset.watermark) watermarkText.value = preset.watermark;
                    window.showToast('Preset loaded!', 'info');
                }
            };

            qualityInput.addEventListener('input', (e) => {
                quality = e.target.value / 100;
                qualityVal.innerText = e.target.value + '%';
            });

            // --- File Handling ---
            fileInput.addEventListener('change', handleFiles);

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-active'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
                if(e.dataTransfer.files.length > 0) processFiles(e.dataTransfer.files);
            });
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') fileInput.click();
            });

            document.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        files.push(items[i].getAsFile());
                    }
                }
                if (files.length > 0) processFiles(files);
            });
            
            // Shortcuts
            document.addEventListener('keydown', (e) => {
                if((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if(convertedFiles.length > 0) downloadAll();
                }
                if(e.key === 'Escape') {
                    const modal = document.getElementById('compareModal');
                    if(modal) modal.remove();
                }
                if((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    clearAll();
                }
            });

            function handleFiles(e) {
                if(e.target.files.length > 0) processFiles(e.target.files);
            }

            // --- Main Processing Logic ---
            function processFiles(files) {
                emptyState.classList.add('hidden');
                clearAllBtn.classList.remove('hidden');
                globalProgress.classList.remove('hidden');
                
                const MAX_SIZE = 50 * 1024 * 1024; 
                let validFiles = [];
                
                for(let i=0; i<files.length; i++) {
                    const f = files[i];
                    if(!f.type.startsWith('image/')) continue;
                    if(f.size > MAX_SIZE) {
                         window.showToast(`${f.name} is large (>50MB). Skipped.`, 'error');
                         continue;
                    }
                    validFiles.push(f);
                }

                validFiles.forEach(file => {
                    filesQueue.push({ file, id: Date.now() + Math.random() });
                });
                
                processQueue();
            }
            
            async function processQueue() {
                updateGlobalProgress();
                updateCount();

                while (activeWorkers < MAX_WORKERS && queueIndex < filesQueue.length) {
                    const item = filesQueue[queueIndex++];
                    activeWorkers++;
                    
                    createListItem(item.id, item.file);
                    
                    try {
                        const bitmap = await createImageBitmap(item.file);
                        convertImageInWorker(item.id, item.file, bitmap, queueIndex);
                    } catch (e) {
                        console.warn("Bitmap creation failed", e);
                        markError(item.id, "Invalid Image");
                        activeWorkers--;
                        completedCount++;
                        updateGlobalProgress();
                        processQueue();
                    }
                }
            }

            function createListItem(id, file) {
                const div = document.createElement('div');
                div.id = `item-${id}`;
                div.className = "flex flex-col sm:flex-row items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl shadow-sm fade-in relative overflow-hidden";
                
                const originalUrl = URL.createObjectURL(file);
                div.dataset.original = originalUrl;

                div.innerHTML = `
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 relative group/thumb cursor-pointer" onclick="compare(${id})">
                        <img id="thumb-${id}" class="w-full h-full object-cover opacity-50">
                        <div id="spinner-${id}" class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-circle-notch fa-spin text-indigo-500"></i></div>
                        <div class="absolute inset-0 bg-black/30 hidden group-hover/thumb:flex items-center justify-center text-white"><i class="fa-solid fa-magnifying-glass"></i></div>
                    </div>
                    <div class="flex-grow min-w-0 w-full text-center sm:text-left">
                        <h4 class="text-sm font-bold text-slate-700 truncate" id="name-${id}">${file.name}</h4>
                        <div class="flex items-center justify-center sm:justify-start gap-3 mt-1 text-xs text-slate-500 font-mono">
                            <span>${formatBytes(file.size)}</span> <i class="fa-solid fa-arrow-right text-gray-300"></i>
                            <span id="newSize-${id}" class="text-gray-400">Waiting...</span>
                            <span id="badge-${id}" class="hidden px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold ml-2">SAVED</span>
                        </div>
                        <div id="suggestion-${id}" class="text-[10px] text-blue-500 mt-1 italic hidden"></div>
                    </div>
                    <div class="flex-shrink-0">
                        <a id="dlBtn-${id}" class="hidden bg-indigo-50 hover:bg-indigo-100 text-indigo-600 p-2 rounded-lg transition" title="Download"><i class="fa-solid fa-download"></i></a>
                    </div>
                `;
                resultsList.prepend(div);
                
                // Thumb load
                const reader = new FileReader();
                reader.onload = e => document.getElementById(`thumb-${id}`).src = e.target.result;
                reader.readAsDataURL(file);
            }

            function convertImageInWorker(id, file, bitmap, index) {
                const worker = new Worker(workerUrl);
                
                const settings = {
                    id: id,
                    bitmap: bitmap,
                    format: targetFormat,
                    quality: quality,
                    targetW: parseInt(resizeWidth.value) || 0,
                    targetH: parseInt(resizeHeight.value) || 0,
                    wmText: watermarkText.value.trim(),
                    wmPos: watermarkPos.value,
                    wmOpacity: parseFloat(watermarkOpacity.value) || 0.5,
                    originalSize: file.size
                };
                
                worker.postMessage(settings, [bitmap]);

                worker.onmessage = function(e) {
                    const { blob, success, error, suggestion } = e.data;
                    
                    if (success) {
                        handleSuccess(id, file, blob, index, suggestion);
                    } else {
                        console.error('Worker error:', error);
                        convertImageMainThread(id, file, index);
                    }
                    worker.terminate();
                    activeWorkers--;
                    processQueue();
                };
                
                worker.onerror = function(err) {
                    console.error('Worker error:', err);
                    convertImageMainThread(id, file, index);
                    worker.terminate();
                };
            }
            
            async function convertImageMainThread(id, file, index) {
                 try {
                    const bitmap = await createImageBitmap(file);
                    const canvas = document.createElement('canvas');
                    let width = bitmap.width; let height = bitmap.height;
                    
                    const targetW = parseInt(resizeWidth.value) || 0;
                    const targetH = parseInt(resizeHeight.value) || 0;
                    if (targetW && targetH) { width = targetW; height = targetH; }
                    else if (targetW) { const ratio = targetW / width; width = targetW; height = height * ratio; }
                    else if (targetH) { const ratio = targetH / height; height = targetH; width = width * ratio; }
                    
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(bitmap, 0, 0, width, height);
                    
                    if (watermarkText.value.trim()) {
                        const fontSize = Math.max(12, width * 0.05);
                        ctx.font = `bold ${fontSize}px sans-serif`;
                        ctx.fillStyle = "white";
                        ctx.fillText(watermarkText.value, 20, height - 20);
                    }
                    
                    canvas.toBlob(blob => {
                        handleSuccess(id, file, blob, index, "Processed in Main Thread");
                        activeWorkers--;
                        processQueue();
                    }, targetFormat, quality);
                    
                 } catch(e) {
                     markError(id, "Browser Unsupported");
                     activeWorkers--;
                     completedCount++;
                     updateGlobalProgress();
                     processQueue();
                 }
            }
            
            function handleSuccess(id, file, blob, index, suggestion) {
                completedCount++;
                updateGlobalProgress();
                
                const ext = targetFormat.split('/')[1].replace('jpeg', 'jpg');
                let finalName = file.name.replace(/\.[^/.]+$/, "") + "." + ext;
                
                const prefix = renamePrefix.value.trim();
                if(prefix) finalName = `${prefix}-${String(index + 1).padStart(2, '0')}.${ext}`;

                const newSize = blob.size;
                const savings = ((file.size - newSize) / file.size * 100).toFixed(0);
                const isSaved = newSize < file.size;
                
                document.getElementById(`spinner-${id}`).classList.add('hidden');
                document.getElementById(`thumb-${id}`).classList.remove('opacity-50');
                document.getElementById(`name-${id}`).innerText = finalName;
                document.getElementById(`newSize-${id}`).innerText = formatBytes(newSize);
                document.getElementById(`newSize-${id}`).classList.add(isSaved ? 'text-green-600' : 'text-slate-600');
                
                const badge = document.getElementById(`badge-${id}`);
                badge.classList.remove('hidden');
                badge.innerText = isSaved ? `-${savings}%` : `+${Math.abs(savings)}%`;
                badge.className = isSaved ? "px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold ml-2 text-xs" : "px-1.5 py-0.5 rounded bg-orange-100 text-orange-700 font-bold ml-2 text-xs";

                if(suggestion) {
                    const sugEl = document.getElementById(`suggestion-${id}`);
                    if(sugEl) {
                        sugEl.innerText = "ðŸ’¡ " + suggestion;
                        sugEl.classList.remove('hidden');
                    }
                }

                const url = URL.createObjectURL(blob);
                const dlBtn = document.getElementById(`dlBtn-${id}`);
                dlBtn.href = url;
                dlBtn.download = finalName;
                dlBtn.classList.remove('hidden');
                
                const itemDiv = document.getElementById(`item-${id}`);
                itemDiv.dataset.converted = url;
                
                // Cleanup URL later
                dlBtn.addEventListener('click', () => setTimeout(() => URL.revokeObjectURL(url), 5000));
                
                // Save to DB
                saveToDB(id, blob, finalName);
                
                convertedFiles.push({ name: finalName, blob: blob });
                if(convertedFiles.length > 0) downloadAllBtn.classList.remove('hidden');
                
                window.showToast("Image converted successfully!", 'success');
            }
            
            function markError(id, msg) {
                // Ensure updates happen even if element missing (rare race)
                const spinner = document.getElementById(`spinner-${id}`);
                if(spinner) spinner.classList.add('hidden');
                
                const sizeEl = document.getElementById(`newSize-${id}`);
                if(sizeEl) {
                    sizeEl.innerText = msg;
                    sizeEl.classList.add('text-red-500');
                }
                window.showToast(`Error: ${msg}`, 'error');
            }

            function updateCount() {
                const total = filesQueue.length;
                const completed = completedCount;
                const successful = convertedFiles.length;
                const failed = completed - successful;
                
                let text = `${total} Files`;
                if(total > 0) {
                    text = `${completed}/${total}`;
                    if(failed > 0) text += ` (${failed} failed)`;
                }
                fileCount.innerText = text;
            }
            
            function updateGlobalProgress() {
                const total = filesQueue.length;
                const pct = total > 0 ? (completedCount / total) * 100 : 0;
                globalProgressBar.style.width = `${pct}%`;
                globalProgressText.innerText = `${completedCount}/${total}`;
                globalProgress.setAttribute('aria-valuenow', Math.round(pct));
            }

            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }
            
            // --- UI Components ---
            
            window.clearAll = () => {
                // Cleanup URLs first
                document.querySelectorAll('[data-original]').forEach(el => {
                     URL.revokeObjectURL(el.dataset.original);
                     if(el.dataset.converted) URL.revokeObjectURL(el.dataset.converted);
                });
                
                resultsList.innerHTML = '';
                resultsList.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                convertedFiles = [];
                filesQueue = [];
                queueIndex = 0;
                completedCount = 0;
                activeWorkers = 0; 
                downloadAllBtn.classList.add('hidden');
                clearAllBtn.classList.add('hidden');
                fileCount.innerText = '0 Files';
                fileInput.value = '';
                globalProgress.classList.add('hidden');
                clearDB();
            };
            
            window.downloadAll = function() {
                const zip = new JSZip();
                convertedFiles.forEach(file => zip.file(file.name, file.blob));
                zip.generateAsync({type:"blob"}).then(function(content) {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(content);
                    a.download = "converted_images.zip";
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
                });
            }
            
            // Toast Notification
            window.showToast = (message, type='success') => {
                let container = document.getElementById('toastContainer');
                if(!container) container = createToastContainer();
                
                const toast = document.createElement('div');
                toast.className = `toast show ${type}`;
                toast.innerText = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            
            function createToastContainer() {
                const div = document.createElement('div');
                div.id = "toastContainer";
                div.className = "fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none";
                document.body.appendChild(div);
                return div;
            }
            
            // Comparison Modal
            window.compare = (id) => {
                const item = document.getElementById(`item-${id}`);
                const orig = item?.dataset.original;
                const conv = item?.dataset.converted;
                if(!orig || !conv) {
                    window.showToast('Image not converted yet', 'error');
                    return;
                }
                
                // Remove existing modal first
                const existingModal = document.getElementById('compareModal');
                if(existingModal) existingModal.remove();
                
                const modal = document.createElement('div');
                modal.id = 'compareModal';
                modal.className = "fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm fade-in";
                modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div class="bg-white rounded-xl overflow-hidden max-w-4xl w-full max-h-[90vh] flex flex-col">
                        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold">Before vs After</h3>
                            <button onclick="document.getElementById('compareModal').remove()" class="text-gray-500 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
                        </div>
                        <div class="flex-grow p-4 flex gap-4 overflow-auto justify-center bg-checkered">
                            <div class="text-center w-1/2">
                                <span class="text-xs font-bold mb-1 block">Original</span>
                                <img src="${orig}" class="max-h-[60vh] object-contain border rounded shadow-sm mx-auto">
                            </div>
                            <div class="text-center w-1/2">
                                <span class="text-xs font-bold mb-1 block text-green-600">Converted</span>
                                <img src="${conv}" class="max-h-[60vh] object-contain border rounded shadow-sm mx-auto">
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Generate Text Report
            window.generateReport = () => {
                if(convertedFiles.length === 0) {
                    window.showToast('No files converted yet!', 'error');
                    return;
                }
                
                const originalTotal = filesQueue.reduce((sum, f) => sum + (f.file ? f.file.size : 0), 0);
                const newTotal = convertedFiles.reduce((sum, f) => sum + f.blob.size, 0);
                
                const spaceSaved = originalTotal - newTotal;
                const percentSaved = originalTotal > 0 
                     ? ((spaceSaved / originalTotal) * 100).toFixed(1) 
                     : 0;
                
                const report = `Image Conversion Report
Generated by Free Online Tools
Date: ${new Date().toLocaleString()}
-----------------------------------
Total Files: ${filesQueue.length}
Successfully Converted: ${convertedFiles.length}
Failed: ${filesQueue.length - convertedFiles.length}
Format: ${targetFormat}
Quality: ${quality * 100}%

Total Original Size: ${formatBytes(originalTotal)}
Total New Size: ${formatBytes(newTotal)}
Space Saved: ${formatBytes(spaceSaved)} (${percentSaved}%)
-----------------------------------
File Details:
${convertedFiles.map(f => `- ${f.name}: ${formatBytes(f.blob.size)}`).join('\n')}
                `;
                
                const blob = new Blob([report], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `conversion-report-${Date.now()}.txt`;
                a.click();
                setTimeout(() => URL.revokeObjectURL(url), 100);
            }

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                // navigator.serviceWorker.register('/sw.js'); // Placeholder for future PWA file
            }

        })();
    </script>
</body>
</html>