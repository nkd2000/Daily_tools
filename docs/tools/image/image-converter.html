<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Image Converter & Resizer | Free Online Tools</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Free online Batch Image Converter. Convert, Resize, and Watermark images instantly. Supports WebP, AVIF, JPG, PNG. Processing happens locally in browser using Web Workers.">
    <meta name="keywords" content="bulk image converter, image resizer, add watermark online, jpg to webp, png to avif, batch photo editor">
    <meta name="author" content="Free Online Tools">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- JSZip for Bulk Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        /* Drag Zone Active State */
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.02);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Accordion Transition */
        .accordion-content { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; }
        .accordion-content.open { max-height: 500px; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">ImgConvert <span class="text-indigo-600 text-xs align-top">PRO</span></span>
                </div>
                <div class="flex items-center gap-6 text-sm font-medium text-slate-500">
                    <a href="../../index.html" class="hover:text-indigo-600 transition">Home</a>
                    <a href="../../pages/contact.html" class="hover:text-indigo-600 transition">Contact</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-10 sm:px-6 w-full">
        
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 mb-3">
                Batch Image Processor
            </h1>
            <p class="text-slate-500 text-lg max-w-2xl mx-auto">
                Convert, Resize, and Watermark multiple images. <span class="text-indigo-600 font-bold">Web Worker Powered</span> for max speed.
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- Left: Settings & Upload -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- 1. Conversion Settings -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-format')" aria-expanded="true">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-file-export text-indigo-500"></i> Format & Quality</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-format" class="accordion-content open p-6 border-t border-gray-100">
                        <div class="space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Output Format</label>
                                <div class="grid grid-cols-2 gap-2" role="group" aria-label="Output Format Selection">
                                    <button onclick="setFormat('image/webp', this)" class="format-btn active bg-indigo-600 text-white py-2 rounded-lg text-sm font-bold border border-indigo-600 transition">WebP</button>
                                    <button onclick="setFormat('image/jpeg', this)" class="format-btn bg-white text-slate-600 py-2 rounded-lg text-sm font-bold border border-gray-200 hover:border-gray-300 transition">JPG</button>
                                    <button onclick="setFormat('image/png', this)" class="format-btn bg-white text-slate-600 py-2 rounded-lg text-sm font-bold border border-gray-200 hover:border-gray-300 transition">PNG</button>
                                    <button onclick="setFormat('image/avif', this)" class="format-btn bg-white text-slate-600 py-2 rounded-lg text-sm font-bold border border-gray-200 hover:border-gray-300 transition relative">
                                        AVIF <span class="absolute -top-1 -right-1 flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                                    </button>
                                </div>
                            </div>
                            <div id="qualityControl">
                                <div class="flex justify-between mb-2">
                                    <label class="text-xs font-bold text-slate-500 uppercase">Quality</label>
                                    <span class="text-xs font-bold text-indigo-600" id="qualityVal">80%</span>
                                </div>
                                <input type="range" id="quality" min="10" max="100" value="80" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" aria-label="Image Quality">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Resize Settings -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-resize')" aria-expanded="false">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-ruler-combined text-blue-500"></i> Resize (Optional)</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-resize" class="accordion-content p-6 border-t border-gray-100">
                        <div class="space-y-4">
                            <!-- Presets -->
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button onclick="setPresetResize(1280, 720)" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded">HD (720p)</button>
                                <button onclick="setPresetResize(1920, 1080)" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded">FHD (1080p)</button>
                                <button onclick="setPresetScale(0.5)" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded">50% Scale</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Width (px)</label>
                                    <input type="number" id="resizeWidth" placeholder="Auto" class="w-full border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Height (px)</label>
                                    <input type="number" id="resizeHeight" placeholder="Auto" class="w-full border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Watermark Settings -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                    <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-watermark')" aria-expanded="false">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-stamp text-purple-500"></i> Watermark</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-watermark" class="accordion-content p-6 border-t border-gray-100">
                         <div class="space-y-4">
                             <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Text</label>
                                <input type="text" id="watermarkText" placeholder="e.g. Â© MyWebsite" class="w-full border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Position</label>
                                    <select id="watermarkPos" class="w-full border-gray-300 rounded-lg text-sm p-2">
                                        <option value="bottom-right">Bottom Right</option>
                                        <option value="bottom-left">Bottom Left</option>
                                        <option value="top-right">Top Right</option>
                                        <option value="top-left">Top Left</option>
                                        <option value="center">Center</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Opacity</label>
                                    <input type="number" id="watermarkOpacity" value="0.5" step="0.1" min="0.1" max="1" class="w-full border-gray-300 rounded-lg text-sm p-2">
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
                
                <!-- 4. Renaming -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                     <button class="w-full px-6 py-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition" onclick="toggleAccordion('settings-rename')" aria-expanded="false">
                        <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-i-cursor text-teal-500"></i> Rename Files</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div id="settings-rename" class="accordion-content p-6 border-t border-gray-100">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Filename Prefix</label>
                        <div class="flex items-center gap-2">
                             <input type="text" id="renamePrefix" placeholder="image" class="flex-grow border-gray-300 rounded-lg text-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                             <span class="text-gray-400 text-sm">-01.ext</span>
                        </div>
                    </div>
                </div>

                <!-- Upload Area -->
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 bg-slate-50 hover:bg-white hover:border-indigo-400 transition cursor-pointer text-center group relative focus-within:ring-2 focus-within:ring-indigo-500" tabindex="0">
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                    <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                    </div>
                    <h3 class="text-slate-700 font-bold mb-1">Click, Paste or Drop Images</h3>
                    <p class="text-slate-400 text-xs">Supports JPG, PNG, WEBP, BMP</p>
                </div>
                
                <!-- Download All -->
                <button id="downloadAllBtn" onclick="downloadAll()" class="hidden w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-zipper"></i> Download All as ZIP
                </button>

            </div>

            <!-- Right: Results -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden min-h-[600px] flex flex-col">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Conversion Queue</h3>
                        <div class="flex items-center gap-3">
                             <!-- Global Progress -->
                             <div id="globalProgress" class="hidden flex items-center gap-2 mr-2">
                                <div class="w-24 bg-gray-200 rounded-full h-2">
                                    <div id="globalProgressBar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                                <span id="globalProgressText" class="text-xs text-slate-500 font-mono">0/0</span>
                             </div>

                             <button onclick="clearAll()" class="text-xs text-red-500 hover:text-red-700 font-medium hidden" id="clearAllBtn">Clear All</button>
                             <span class="text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md" id="fileCount">0 Files</span>
                        </div>
                    </div>
                    
                    <div id="resultsList" class="flex-grow p-6 space-y-4 overflow-y-auto max-h-[800px]">
                        <!-- Empty State -->
                        <div id="emptyState" class="text-center py-32 text-gray-400">
                            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-regular fa-images text-4xl opacity-50"></i>
                            </div>
                            <p>Upload or Paste (Ctrl+V) images to start processing.</p>
                        </div>
                        
                        <!-- List Items -->
                    </div>
                </div>
            </div>

        </div>

    </main>

    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-slate-500">
                &copy; 2023 Free Online Tools. <a href="../../pages/privacy.html" class="text-indigo-600 hover:text-indigo-500">Privacy Policy</a>
            </p>
        </div>
    </footer>

    <script>
        (function() {
            // Worker Script as Blob (To avoid external file dependency)
            const workerCode = `
                self.onmessage = async function(e) {
                    const { bitmap, format, quality, targetW, targetH, wmText, wmPos, wmOpacity, id } = e.data;
                    
                    try {
                        let width = bitmap.width;
                        let height = bitmap.height;
                        
                        // Resize Logic
                        if (targetW && targetH) { width = targetW; height = targetH; }
                        else if (targetW) { const ratio = targetW / width; width = targetW; height = height * ratio; }
                        else if (targetH) { const ratio = targetH / height; height = targetH; width = width * ratio; }
                        
                        // Use OffscreenCanvas if supported
                        let canvas;
                        if (typeof OffscreenCanvas !== 'undefined') {
                            canvas = new OffscreenCanvas(width, height);
                        } else {
                            // Fallback logic handled in main thread, but here we can't create DOM element.
                            // If OffscreenCanvas not supported, we must fail and let main thread handle.
                            throw new Error("OffscreenCanvas not supported");
                        }

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(bitmap, 0, 0, width, height);

                        // Watermark Logic
                        if (wmText) {
                            const fontSize = Math.max(12, width * 0.05);
                            ctx.font = \`bold \${fontSize}px sans-serif\`;
                            ctx.globalAlpha = wmOpacity;
                            ctx.fillStyle = "white";
                            ctx.shadowColor="rgba(0,0,0,0.5)"; 
                            ctx.shadowBlur=4;
                            
                            const metrics = ctx.measureText(wmText);
                            const txtW = metrics.width;
                            const txtH = fontSize;
                            const pad = 20;
                            
                            let x, y;
                            if(wmPos === 'bottom-right') { x = width - txtW - pad; y = height - pad; }
                            else if(wmPos === 'bottom-left') { x = pad; y = height - pad; }
                            else if(wmPos === 'top-right') { x = width - txtW - pad; y = txtH + pad; }
                            else if(wmPos === 'top-left') { x = pad; y = txtH + pad; }
                            else { x = (width - txtW)/2; y = (height + txtH)/2; }
                            
                            ctx.fillText(wmText, x, y);
                        }

                        const blob = await canvas.convertToBlob({ type: format, quality: quality });
                        self.postMessage({ id, blob, success: true });

                    } catch (err) {
                        self.postMessage({ id, error: err.message, success: false });
                    }
                };
            `;
            
            const workerBlob = new Blob([workerCode], { type: "application/javascript" });
            const workerUrl = URL.createObjectURL(workerBlob);
            
            // State
            let targetFormat = 'image/webp';
            let quality = 0.8;
            let filesQueue = [];
            let convertedFiles = []; 
            let workerPool = [];
            const MAX_WORKERS = navigator.hardwareConcurrency || 4;

            // Elements
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.getElementById('dropZone');
            const qualityInput = document.getElementById('quality');
            const qualityVal = document.getElementById('qualityVal');
            const resultsList = document.getElementById('resultsList');
            const emptyState = document.getElementById('emptyState');
            const fileCount = document.getElementById('fileCount');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const formatBtns = document.querySelectorAll('.format-btn');
            const qualityControl = document.getElementById('qualityControl');
            
            // Progress Bar
            const globalProgress = document.getElementById('globalProgress');
            const globalProgressBar = document.getElementById('globalProgressBar');
            const globalProgressText = document.getElementById('globalProgressText');
            
            // Inputs
            const resizeWidth = document.getElementById('resizeWidth');
            const resizeHeight = document.getElementById('resizeHeight');
            const watermarkText = document.getElementById('watermarkText');
            const watermarkPos = document.getElementById('watermarkPos');
            const watermarkOpacity = document.getElementById('watermarkOpacity');
            const renamePrefix = document.getElementById('renamePrefix');

            // --- UI Helper Functions ---
            window.toggleAccordion = (id) => {
                const el = document.getElementById(id);
                el.classList.toggle('open');
                const btn = el.previousElementSibling;
                btn.setAttribute('aria-expanded', el.classList.contains('open'));
            };
            
            window.setFormat = (fmt, btn) => {
                targetFormat = fmt;
                formatBtns.forEach(b => {
                    b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                    b.classList.add('bg-white', 'text-slate-600', 'border-gray-200');
                });
                btn.classList.remove('bg-white', 'text-slate-600', 'border-gray-200');
                btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                
                if(fmt === 'image/png') qualityControl.classList.add('opacity-50', 'pointer-events-none');
                else qualityControl.classList.remove('opacity-50', 'pointer-events-none');
            };

            window.setPresetResize = (w, h) => {
                resizeWidth.value = w;
                resizeHeight.value = h;
            };
            
            window.setPresetScale = (scale) => {
                // This would need image dimension knowledge, 
                // for bulk we can just pass a flag or handle in worker if we sent scale factor
                // For simplicity, let's clear explicit px values and rely on logic
                resizeWidth.value = '';
                resizeHeight.value = '';
                alert("Scale preset requires specific image context. Please enter pixel values for bulk resize.");
            };

            qualityInput.addEventListener('input', (e) => {
                quality = e.target.value / 100;
                qualityVal.innerText = e.target.value + '%';
            });

            // --- File Handling ---
            fileInput.addEventListener('change', handleFiles);

            // Drag & Drop
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-active'); });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-active');
                if(e.dataTransfer.files.length > 0) processFiles(e.dataTransfer.files);
            });
            dropZone.addEventListener('click', () => fileInput.click());
            
            // Key Navigation for DropZone
            dropZone.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    fileInput.click();
                }
            });

            // Paste Support
            document.addEventListener('paste', (e) => {
                const items = e.clipboardData.items;
                const files = [];
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        files.push(items[i].getAsFile());
                    }
                }
                if (files.length > 0) processFiles(files);
            });

            function handleFiles(e) {
                if(e.target.files.length > 0) processFiles(e.target.files);
            }

            async function processFiles(files) {
                emptyState.classList.add('hidden');
                clearAllBtn.classList.remove('hidden');
                globalProgress.classList.remove('hidden');
                
                let processedCount = 0;
                const totalFiles = files.length;
                globalProgressBar.style.width = '0%';
                globalProgressText.innerText = `0/${totalFiles}`;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if(!file.type.startsWith('image/')) continue;
                    
                    const id = Date.now() + i;
                    createListItem(id, file);
                    
                    // Create Bitmap (Main Thread) -> Worker
                    try {
                        const bitmap = await createImageBitmap(file);
                        await convertImageInWorker(id, file, bitmap, i);
                    } catch (e) {
                        markError(id, "Invalid Image");
                    }
                    
                    processedCount++;
                    const pct = (processedCount / totalFiles) * 100;
                    globalProgressBar.style.width = `${pct}%`;
                    globalProgressText.innerText = `${processedCount}/${totalFiles}`;
                }
                
                updateCount();
            }

            function createListItem(id, file) {
                const div = document.createElement('div');
                div.id = `item-${id}`;
                div.className = "flex flex-col sm:flex-row items-center gap-4 bg-white border border-gray-100 p-4 rounded-xl shadow-sm fade-in relative overflow-hidden";
                div.innerHTML = `
                    <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 relative">
                        <img id="thumb-${id}" class="w-full h-full object-cover opacity-50">
                        <div id="spinner-${id}" class="absolute inset-0 flex items-center justify-center"><i class="fa-solid fa-circle-notch fa-spin text-indigo-500"></i></div>
                    </div>
                    <div class="flex-grow min-w-0 w-full text-center sm:text-left">
                        <h4 class="text-sm font-bold text-slate-700 truncate" id="name-${id}">${file.name}</h4>
                        <div class="flex items-center justify-center sm:justify-start gap-3 mt-1 text-xs text-slate-500 font-mono">
                            <span>${formatBytes(file.size)}</span> <i class="fa-solid fa-arrow-right text-gray-300"></i>
                            <span id="newSize-${id}" class="text-gray-400">Waiting...</span>
                            <span id="badge-${id}" class="hidden px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold ml-2">SAVED</span>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <a id="dlBtn-${id}" class="hidden bg-indigo-50 hover:bg-indigo-100 text-indigo-600 p-2 rounded-lg transition" title="Download"><i class="fa-solid fa-download"></i></a>
                    </div>
                `;
                resultsList.prepend(div);
                const reader = new FileReader();
                reader.onload = e => document.getElementById(`thumb-${id}`).src = e.target.result;
                reader.readAsDataURL(file);
            }

            function convertImageInWorker(id, file, bitmap, index) {
                return new Promise((resolve) => {
                    const worker = new Worker(workerUrl);
                    
                    // Prepare settings
                    const settings = {
                        id: id,
                        bitmap: bitmap,
                        format: targetFormat,
                        quality: quality,
                        targetW: parseInt(resizeWidth.value) || 0,
                        targetH: parseInt(resizeHeight.value) || 0,
                        wmText: watermarkText.value.trim(),
                        wmPos: watermarkPos.value,
                        wmOpacity: parseFloat(watermarkOpacity.value) || 0.5
                    };
                    
                    worker.postMessage(settings, [bitmap]); // Transfer bitmap

                    worker.onmessage = function(e) {
                        const { blob, success, error } = e.data;
                        
                        if (success) {
                            handleSuccess(id, file, blob, index);
                        } else {
                            // Fallback to main thread if OffscreenCanvas fails? 
                            // For simplicity, we just show error here. 
                            console.error(error);
                            markError(id, "Worker Error");
                        }
                        worker.terminate();
                        resolve();
                    };
                    
                    worker.onerror = function(err) {
                        markError(id, "Failed");
                        worker.terminate();
                        resolve();
                    };
                });
            }
            
            function handleSuccess(id, file, blob, index) {
                const ext = targetFormat.split('/')[1].replace('jpeg', 'jpg');
                let finalName = file.name.replace(/\.[^/.]+$/, "") + "." + ext;
                
                const prefix = renamePrefix.value.trim();
                if(prefix) finalName = `${prefix}-${String(index + 1).padStart(2, '0')}.${ext}`;

                const newSize = blob.size;
                const savings = ((file.size - newSize) / file.size * 100).toFixed(0);
                const isSaved = newSize < file.size;
                
                document.getElementById(`spinner-${id}`).classList.add('hidden');
                document.getElementById(`thumb-${id}`).classList.remove('opacity-50');
                document.getElementById(`name-${id}`).innerText = finalName;
                document.getElementById(`newSize-${id}`).innerText = formatBytes(newSize);
                document.getElementById(`newSize-${id}`).classList.add(isSaved ? 'text-green-600' : 'text-slate-600');
                
                const badge = document.getElementById(`badge-${id}`);
                badge.classList.remove('hidden');
                badge.innerText = isSaved ? `-${savings}%` : `+${Math.abs(savings)}%`;
                badge.className = isSaved ? "px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold ml-2 text-xs" : "px-1.5 py-0.5 rounded bg-orange-100 text-orange-700 font-bold ml-2 text-xs";

                const url = URL.createObjectURL(blob);
                const dlBtn = document.getElementById(`dlBtn-${id}`);
                dlBtn.href = url;
                dlBtn.download = finalName;
                dlBtn.classList.remove('hidden');
                
                convertedFiles.push({ name: finalName, blob: blob });
                if(convertedFiles.length > 1) downloadAllBtn.classList.remove('hidden');
            }
            
            function markError(id, msg) {
                document.getElementById(`spinner-${id}`).classList.add('hidden');
                document.getElementById(`newSize-${id}`).innerText = msg;
                document.getElementById(`newSize-${id}`).classList.add('text-red-500');
            }

            function updateCount() {
                const count = resultsList.children.length - 1; 
                fileCount.innerText = `${count} Files`;
            }

            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }
            
            window.clearAll = () => {
                resultsList.innerHTML = '';
                resultsList.appendChild(emptyState);
                emptyState.classList.remove('hidden');
                convertedFiles = [];
                downloadAllBtn.classList.add('hidden');
                clearAllBtn.classList.add('hidden');
                fileCount.innerText = '0 Files';
                fileInput.value = '';
                globalProgress.classList.add('hidden');
            };
            
            window.downloadAll = function() {
                const zip = new JSZip();
                convertedFiles.forEach(file => zip.file(file.name, file.blob));
                zip.generateAsync({type:"blob"}).then(function(content) {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(content);
                    a.download = "converted_images.zip";
                    a.click();
                });
            }

        })();
    </script>
</body>
</html>